### 中间件

#### 基本概念

- 中间件是一种功能的封装方式，处理 HTTP 请求的功能，通过app.use添加中间件

- 中间件只是一个有 3 个参数的函数：一个请求对象、一个响应对象和一个 next 函数（还有一种 4 个参数的形式，用来做错误处理）

- 中间件是在管道中执行的，按顺序处理

- 在管道的最后放一个“捕获一切”请求的处理器是常见的做法，由它来处理跟前面其他所有路由都不匹配的请求。这个中间件一般会返回状态码 404（未找到）。

#### 重点注意

- 路由处理器（app.get、app.post等）可以被看作只处理特定HTTP 谓词（GET、POST 等）的中间件。同样，也可以将中间件看作可以处理全部 HTTP谓词的路由处理器（基本上等同于 app.all，可以处理任何 HTTP 谓词

- 路由处理器的第一个参数必须是路径。如果你想让某个路由匹配所有路径，只需用 /*。中间件也可以将路径作为第一个参数，但它是可选的（如果忽略这个参数，它会匹配所有路径，就像指定了 /\* 一样）。

- 路由处理器和中间件的参数中都有回调函数，这个函数有 2 个、3 个或 4 个参数，如果有 2 个或 3 个参数，头两个参数是请求和响应对象，第三个参数是 next 函数。如果有 4 个参数，它就变成了错误处理中间件，第一个参数变成了错误对象

- 那么请求在管道中如何“终止”呢？这是由传给每个中间件的 next 函数来实现的。如果不调用 next()，请求就在那个中间件中终止了，此时应该发送一个响应到客户端（res.send、res.json、res.render 等）

- 如果调用了 next()，一般不宜再发送响应到客户端。如果你发送了，管道中后续的中间件或路由处理器还会执行，但它们发送的任何响应都会被忽略